\chapter{Integral Height Function Coefficient Code}\label{appendixb}
The following code was written in Matlab to find finite difference coefficients for the integral $5^{th}$ order  height function method.
\begin{singlespace}
\begin{lstlisting}
% Compute weights for 5th order height function method
clear; clc
syms x z xik zik dx_ dz

% Order of expansion
M=5; N=0;

% Taylor series incluing upto max(M,N) order terms
h=sym(zeros(M+1,N+1));
for n=0:N
for m=0:M
h(m+1,n+1)=(x-xik)^m*(z-zik)^n/(factorial(m)*factorial(n));
end
end

% Allocate Matrices
Z=sym(zeros((M+1)*(N+1),(M+1)*(N+1)));

B=sym(eye  ((M+1)*(N+1),(M+1)*(N+1)));

% Loop over cells in stencil
c=0;
for kp=0;%-3:2
for ip=-3:2
c=c+1; % Column number
%fprintf('%i/6 \n',c)
% Integrate h over this cell to form height
H=int(h,x,xik+(ip)*dx_,xik+(ip+1)*dx_)/(dx_);
% Get coefficents from F
Z(:,c)=H(:);
end
end


% Solve for A's (in a vector)
Av=Z\B;

%%   Weights for needed derivatives    %
% ------------------------------------ %
dx_=1;
c=0;
for n=0;%:N
for m=0:M
c=c+1;
if     m==1 && n==0;  hx =eval(reshape(Av(:,c),6,1)); % h_x
elseif m==0 && n==1;  hz =eval(reshape(Av(:,c),5,5)); % h_z
elseif m==2 && n==0;  hxx=eval(reshape(Av(:,c),6,1)); % h_xx
elseif m==0 && n==2;  hzz=eval(reshape(Av(:,c),5,5)); % h_zz
elseif m==1 && n==1;  hxz=eval(reshape(Av(:,c),5,5)); % h_xz
end
end
% Test accuracy
figure(1); clf(1)
syms x z
% Function
f=x^5+2*x*cos(x);
% Location to compute derivative
xo=1;
zo=1;

% Compute integral of f for construction of heights
syms z1 z2 x1 x2
intf=matlabFunction(int(int(f,z,z1,z2),x,x1,x2),'Vars',[x1,x2,z1,z2]);

% Loop over derivatives to test
c=0;
for n=0:N % d/dy^n
for m=0:M % d/dx^m
c=c+1;
% Get correct A's for this derivative
A=reshape(Av(:,c),6,1);

% Grid size to compute heights on
dxs=[1,1/2,1/4,1/8,1/16,1/32,1/64];
error=zeros(1,length(dxs));
for ndx=1:length(dxs);
dx=dxs(ndx);
dz=1; %dxs(ndx);
exact=subs(diff(diff(f,z,n),x,m),[x,z],[xo,zo]);
% Compute heights
ht=zeros(6,1);
for j=0;%-2:2
for i=-3:2
ht(i+4,j+1)=intf(xo+(i)*dx,xo+(i+1)*dx,zo+(j-1/2)*dz,zo+(j+1/2)*dz)/(dx*dz);
end
end

% Perform sum(A*heights) (Evaluates A with this dx/dy)
dx_=dx;
computed=sum(sum(eval(A).*ht));

% Analysis
error(ndx)=abs(exact-computed);
if c==2 || c ==3 
h=figure(c); clf(c)  
plot(N+1,M+1)
loglog(dxs,error,'-.','LineWidth',3)
hold on
loglog(dxs,dxs.^5,'LineWidth',3)
title(['d/dx^',num2str(m),' d/dy^',num2str(n)],'interpreter','latex','fontsize',16)
legend('5th Order Method','5th Order', 'Location', 'NorthWest')
set(gca, 'Color', 'none','Fontsize',16);
drawnow 
basefile = 'figs';
saveas(h,fullfile(basefile,['WeightsDer',num2str(c),'.png']));
end
end
end
\end{lstlisting}
\end{singlespace}